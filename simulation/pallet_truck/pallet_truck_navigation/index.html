<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Hamid Ebadi" /><link rel="canonical" href="https://infotiv-research.github.io/SIMLAN/simulation/pallet_truck/pallet_truck_navigation/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Navigation - SIMLAN, Simulation for Multi-Camera Robotics</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Navigation";
        var mkdocs_page_input_path = "simulation/pallet_truck/pallet_truck_navigation/README.md";
        var mkdocs_page_url = "/SIMLAN/simulation/pallet_truck/pallet_truck_navigation/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> SIMLAN, Simulation for Multi-Camera Robotics
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">SIMLAN, Simulation for Multi-Camera Robotics</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../dependencies/">Dependencies</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../contributing/">Contributing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../config_generation/">Config Generation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Simulation</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../simlan_gazebo_environment/worlds/">Gazebo Worlds</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../static_agent_launcher/">GPSS cameras</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../camera_bird_eye_view/">Camera Bird Eye View</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../aruco_localization/">Aruco Localization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../bt_failsafe/">Failsafe</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../simlan_bringup/">SIMLAN Bringup</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Pallet Truck</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../pallet_truck_bringup/">Bringup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../pallet_truck_description/urdf/">URDF</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../pallet_truck_control/">Control</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Navigation</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#map-server">Map server</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#robot_agent-navigation">Robot_agent navigation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#humanoid_navigation">Humanoid_navigation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#obstacles-detection-update_map_node">Obstacles detection (update_map_node)</a>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Humanoid Robot</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../humanoid_robot/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../humanoid_support_moveit_config/">Humanoid Moveit</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../moveit2/">Panda MoveIt2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../object_mover/">Object Mover</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Humanoid Motion Capture Utility</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../humanoid_utility/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../humanoid_utility/pose_to_motion/autogluon/">Pose to Motion AutoGluon model</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Models</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../raw_models/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../raw_models/objects/">Object Modeling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../raw_models/warehouse/">Warehouse Specification</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../credits/">Credits</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CHANGELOG/">Changelog</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../resources/ISSUES/">Issues</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../resources/diagrams/">Diagrams</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">SIMLAN, Simulation for Multi-Camera Robotics</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Simulation</li>
          <li class="breadcrumb-item">Pallet Truck</li>
      <li class="breadcrumb-item active">Navigation</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/infotiv-research/SIMLAN/edit/master/docs/simulation/pallet_truck/pallet_truck_navigation/README.md">Edit on infotiv-research/SIMLAN</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="navigation-robot-agent-and-humanoid-and-map-server">Navigation (Robot agent and Humanoid) and Map server</h1>
<h3 id="map-server">Map server</h3>
<p>Instead of starting with an empty map, to get the general layout of the environment and detect the static object in the environment (walls, cooridors and hallways) you can <strong>optionally</strong> build a map.
To start mapping (otherwise known as cartography), you can use <code>cartography.launch.py</code>. It requires a lidar to be mounted on the <code>robot_agent</code> and <code>odometry</code> to exist, which can be activated from the  <code>camera_utility/aruco_localization</code> package. </p>
<p>Launch the following package, run gazebo, rviz, aruco_localization, and start moving around the simulation with the robot_agent. When you are finished you need to save it using this command: <code>ros2 run nav2_map_server map_saver_cli -f simulation/pallet_truck/pallet_truck_navigation/maps/YOUR_MAP_NAME</code>. Keep in mind that this step needs to be done only once and the map assumed to be static.</p>
<p>We only have one map for all navigation stack. This simplify making obstacle and other robot agent to all other robot agents.</p>
<pre><code>Node(  # Manually setting the joint between map and odom to 0 0 0, i.e. identical to each other. map -&gt; odom
  package=&quot;tf2_ros&quot;,
  executable=&quot;static_transform_publisher&quot;,
  name=&quot;static_world_to_map&quot;,
  arguments=[&quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;world&quot;, &quot;map&quot;],
  ...
)
</code></pre>
<h3 id="robot_agent-navigation">Robot_agent navigation</h3>
<p>This package covers the functionality of mapping, localizing, and navigation for the robot_agent. Each package is built using code from the nav2 packages, thus you are able to modify the launch files but to change the node's behaviour you need to modify the config files. The code is tailored for the robot_agent and using the <code>aruco_detection</code> package that supplies <code>/TF</code> chain for the truck.</p>
<ul>
<li>The <code>aruco_localization</code> package runs the aruco localisation.</li>
<li>The <code>map_server.py</code> creates a map for each agent</li>
<li>The <code>nav2.launch.py</code> uses the localisation (from the previous steps) for the  navigation of the robot_agent.</li>
</ul>
<p>Keep in mind that the same namespace has to be used when launching the navigation stack which is done automatically:  <code>ros2 launch pallet_truck_navigation nav2.launch.py robots:=ROBOTS</code></p>
<p>For navigation to be able to automatically find the robot agent, we have to set a namespace that specified when launching the robot_agent. (see above)</p>
<p>Each robot has it own navigation configuration in <code>nav2_params.yaml</code> which is dynamically generated on build based on the <code>ROBOTS</code> variable in config.sh. the pallet_trucks and forklifts also have an individual <code>navigate_w_replaning_and_recovery_robot_agent_x.xml</code> which is supposed to stop the navigation of the agents if their aruco_markers are not detected. The topic which publishes the "seen" aruco_markers is called <code>/aruco_marker_seen</code> and can be visualized after running gpss and nav.</p>
<p>We use following <code>/TF</code> structure:</p>
<p><img alt="view_frames.png" src="view_frames.png" /></p>
<p><strong>Note</strong> that <code>world</code> and <code>map</code> are static at the same position. <code>robot_agent_X/odom</code> is static at the position from where the robots are spawned and the new position of the robots are then determined by <code>robot_agent_X/base_link</code> which is a dynamic transform from <code>robot_agent_X/odom</code>.</p>
<p>Good video to watch for multi agent navigation: https://www.youtube.com/watch?v=cGUueuIAFgw</p>
<h3 id="humanoid_navigation">Humanoid_navigation</h3>
<p>The humanoid navigation is implemented in the same way as for the robot_agents with the difference of calling the function <code>./control.sh nav HUMANOIDS</code>. Then the same principles apply but with a different nav2_parameter file being used as an argument to nav2 nodes. At the moment there is an issue with the actual TF values in rvis and simulation in gazebo not matching which is described in <code>simulation/humanoid_support_moveit_config/README.md</code> under bugs. When this is fixed, the navigation should work.</p>
<p>There is one major difference between the navigation of the humanoids and the robot_agents. The robot _agents get their <code>odom</code> frame from the aruco_localization pkg which find aruco_markers and publishes their orientation and position. The humanoids on the other hand get their <code>odom</code> frame from the ros2_controller <code>simulation/humanoid_support_moveit_config/launch/launch_controllers.launch.py</code>. This means the robot_agents get their odom frame from what the cameras can see and the humanoids get their odom frame from what the ros2 controller publishes.</p>
<h2 id="obstacles-detection-update_map_node">Obstacles detection (update_map_node)</h2>
<p>We have static objects in the map and initially we updated that single map with dynamic obstacles (Robot_agents). The problem with this single map was that nav2 navigation stack of robot_agent_1 sees itself within the obstacle created for robot_agent_1 (<strong>itself</strong>). Therefore it is decided that each robot_agent has its own map that has everything except itself.  So this is a node to create a map with dynamic obstacles around all <strong>other</strong> existing robot_agents in the simulation. Each robot is assigned a map_server and this node sends an updated map with all other robots_agents as obstacle to the correct namespaced map_server.</p>
<p>The node is launched in <code>pallet_truck/pallet_truck_navigation/launch/nav2.launch.py</code></p>
<hr />
<p>The <code>/map_updater/update_map_node.py</code> node works as following:</p>
<p>First it makes a copy of the <code>warehouse.pgm</code> map which is a long array of pixel values ranging from (0-255) and saves it as <code>original_array</code>. Since the map nav2 needs has a different setup than the <code>.pgm</code> file, a conversion is needed.</p>
<p>The .pgm file has these pixels ranges</p>
<table>
<thead>
<tr>
<th>value</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>black obstacle</td>
</tr>
<tr>
<td>255</td>
<td>White Free space</td>
</tr>
<tr>
<td>1-254</td>
<td>ranges of gray, not defined at the moment</td>
</tr>
</tbody>
</table>
<p>The map nav2 needs is set up with pixels ranging from (-1-100) where</p>
<table>
<thead>
<tr>
<th>value</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>-1</td>
<td>Unknown</td>
</tr>
<tr>
<td>0</td>
<td>Free space</td>
</tr>
<tr>
<td>100</td>
<td>obstacle</td>
</tr>
<tr>
<td>1-99</td>
<td>probabilistic occupancy</td>
</tr>
</tbody>
</table>
<p>therefore this has to be parsed to match by doing the following:</p>
<pre><code class="language-python">current_array = self.original_array.copy()
occupancy_array = np.zeros(current_array.shape, dtype=np.uint8)
occupancy_array[current_array.copy()&lt;100] = 100
</code></pre>
<p>So everything that is supposed to be a wall in the .pgm file is parsed as a wall in the map context</p>
<p>The map is a 2D array, typically stored row-major from bottom-left, but many implementations flip it vertically ([::-1]) to match how image viewers treat top-left as (0,0). and therefore the following is done</p>
<pre><code class="language-python">occupancy_array = occupancy_array[::-1, :]
</code></pre>
<p>Then the position of all other robot_agents are found by their transforms between robot_agent_x/base_link and world and an obstacle is set at their position which is updated with 10Hz to continuously update their positions.</p>
<p>This concept is repeated for all namespaces sent through the ./control.sh nav function.</p>
<p><strong>How often the new path the pallet_trucks can take be update</strong>
add a speed limiter instead of obstacle, in those cases the robot will slow down instead of replanning and avoiding completely update slower could probably mix with the inflation radius's of the costmaps to make robot take wider turns</p>
<p><strong>Collision</strong>
Two robots that are approaching each other (from left and right) don't know where each one is planning to go and they can make the decision to pick the path on top lane instead of one going above and one from bottom.</p>
<p>Possible solution: block future path on every other robots map!</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../pallet_truck_control/" class="btn btn-neutral float-left" title="Control"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../humanoid_robot/" class="btn btn-neutral float-right" title="Overview">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../pallet_truck_control/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../humanoid_robot/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
